name: Deploy Staging
on:
  push:
    branches: [ develop ]

concurrency:
  group: staging-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy-api:
    runs-on: ubuntu-latest
    environment: staging
    defaults: { run: { working-directory: apps/api } }
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: "22" }
      - name: Install Railway CLI
        run: npm i -g @railway/cli
      - name: Link & deploy API
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          railway link --project ${{ secrets.RW_PROJECT_ID }} --environment ${{ secrets.RW_STAGING_ENV_ID }}
          railway up --service ${{ secrets.RW_API_SERVICE_ID }} --detach
          railway run --service ${{ secrets.RW_API_SERVICE_ID }} -- python manage.py migrate --noinput

  deploy-members-hub:
    runs-on: ubuntu-latest
    environment: staging
    defaults: { run: { working-directory: apps/members-hub } }
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: "22", cache: "pnpm" }
      - run: corepack enable
      - run: pnpm install --frozen-lockfile
      - name: Install Railway CLI
        run: npm i -g @railway/cli
      - name: Link & deploy members-hub
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          railway link --project ${{ secrets.RW_PROJECT_ID }} --environment ${{ secrets.RW_STAGING_ENV_ID }}
          railway up --service ${{ secrets.RW_MEMBERS_SERVICE_ID }} --detach

  deploy-clock-kiosk:
    runs-on: ubuntu-latest
    environment: staging
    defaults: { run: { working-directory: apps/clock-kiosk } }
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: "22", cache: "pnpm" }
      - run: corepack enable
      - run: pnpm install --frozen-lockfile
      - name: Install Railway CLI
        run: npm i -g @railway/cli
      - name: Link & deploy clock-kiosk
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          railway link --project ${{ secrets.RW_PROJECT_ID }} --environment ${{ secrets.RW_STAGING_ENV_ID }}
          railway up --service ${{ secrets.RW_KIOSK_SERVICE_ID }} --detach
